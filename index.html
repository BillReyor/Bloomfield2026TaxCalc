<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta 
    name="viewport" 
    content="width=device-width, initial-scale=1.0" 
  />
  <meta 
    name="description" 
    content="Bloomfield real estate tax calculator for FY 2025–FY 2029 (four-year phase-in with equalized mill baseline)"
  />
  <meta name="author" content="Created by William Reyor" />
  <title>Bloomfield Tax Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Small tweak so the version number sits a bit below the results. */
    #version { 
      margin-top: 1rem; 
      font-size: 0.85rem; 
      color: #6B7280; /* Tailwind gray-500 */ 
      text-align: center; 
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-3xl mx-auto py-8 px-4">
    <h1 class="text-3xl font-bold text-center mb-6">
      Bloomfield Tax Calculator (FY 2025–FY 2029)
    </h1>

    <p class="mb-6 text-gray-700 leading-relaxed">
      Enter your property’s <strong>Full 100% Post-Revaluation Assessed Value</strong> (the
      number you get after multiplying the new market value by 0.7). Then enter your 
      <strong>Old (Pre-Reval) Assessed Value</strong> (the assessment you had before
      October 2024). You must supply one of those two to see an accurate four-year phase-in. 
      If you leave “Old” blank, you may instead enter a <strong>Revaluation Increase (%)</strong> 
      and we’ll infer “Old” from that. If both are blank, we show a warning.  
    </p>

    <!--────────────────────────────────────
      Simple Input Section
    ────────────────────────────────────-->
    <div class="bg-white shadow-md rounded-lg p-6 mb-6 space-y-6">
      <h2 class="text-xl font-semibold mb-4 border-b pb-2">Assessed Values</h2>

      <!-- Full Post-Reval (100%) Assessed Value -->
      <div>
        <label for="assessedPost" class="block font-medium mb-1">
          Full Post-Revaluation Assessed Value (100%)
        </label>
        <input
          type="number"
          id="assessedPost"
          class="w-full p-2 border border-gray-300 rounded"
          placeholder="e.g. 262710"
          value="262710"
          aria-describedby="assessedPostHelp"
        />
        <p id="assessedPostHelp" class="mt-1 text-sm text-gray-500">
          The fully revalued assessment (70% of your new market value). 
          <strong>Do not enter 25%-phased numbers</strong>—this must be the 100% revalued figure.
        </p>
      </div>

      <!-- Old (Pre-Reval) Assessed Value -->
      <div>
        <label for="assessedPre" class="block font-medium mb-1">
          Old (Pre-Revaluation) Assessed Value
        </label>
        <input
          type="number"
          id="assessedPre"
          class="w-full p-2 border border-gray-300 rounded"
          placeholder="e.g. 169470"
          value=""
          aria-describedby="assessedPreHelp"
        />
        <p id="assessedPreHelp" class="mt-1 text-sm text-gray-500">
          (Optional) If you know your old assessment before October 2024, enter it here.
        </p>
      </div>

      <p class="text-center text-gray-600 italic">― or ―</p>

      <!-- Revaluation Increase Percentage -->
      <div>
        <label for="revalPct" class="block font-medium mb-1">
          Revaluation Increase (%)
        </label>
        <input
          type="number"
          id="revalPct"
          step="0.001"
          class="w-full p-2 border border-gray-300 rounded"
          placeholder="e.g. 0.55 for 55%"
          value=""
          aria-describedby="revalPctHelp"
        />
        <p id="revalPctHelp" class="mt-1 text-sm text-gray-500">
          (Optional) If your notice says “New assessment is 55% higher,” enter 0.55. 
          We’ll back out your old assessed value from that.
        </p>
      </div>
    </div>

    <!--────────────────────────────────────
      Advanced Configuration Toggle
    ────────────────────────────────────-->
    <button
      id="toggleAdvanced"
      aria-expanded="false"
      aria-controls="advancedConfig"
      class="mb-6 text-blue-600 hover:text-blue-800 font-medium focus:outline-none"
    >
      Advanced Configuration ▼
    </button>

    <!--────────────────────────────────────
      Advanced Configuration (hidden by default)
    ────────────────────────────────────-->
    <div
      id="advancedConfig"
      class="hidden transition-all duration-200 bg-white shadow-md rounded-lg p-6 mb-6 space-y-6"
    >
      <h2 class="text-xl font-semibold mb-4 border-b pb-2">
        Advanced Rates & Options
      </h2>

      <!-- Council Mill Rates (FY 2025–FY 2029) -->
      <div>
        <h3 class="text-lg font-semibold mb-2">Council Mill Rates</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="councilY0" class="block font-medium mb-1">
              Council Mill (FY 2025)
            </label>
            <input
              type="number"
              id="councilY0"
              step="0.01"
              class="w-full p-2 border border-gray-300 rounded"
              placeholder="e.g. 37.49"
              value="37.49"
              aria-describedby="councilY0Help"
            />
            <p id="councilY0Help" class="mt-1 text-sm text-gray-500">
              Town Council’s tax rate (mills) for FY 2025.
            </p>
          </div>
          <div>
            <label for="councilY1" class="block font-medium mb-1">
              Council Mill (FY 2026)
            </label>
            <input
              type="number"
              id="councilY1"
              step="0.01"
              class="w-full p-2 border border-gray-300 rounded"
              placeholder="e.g. 35.64"
              value="35.64"
              aria-describedby="councilY1Help"
            />
            <p id="councilY1Help" class="mt-1 text-sm text-gray-500">
              Town Council’s tax rate (mills) for FY 2026.
            </p>
          </div>
          <div>
            <label for="councilY2" class="block font-medium mb-1">
              Council Mill (FY 2027)
            </label>
            <input
              type="number"
              id="councilY2"
              step="0.01"
              class="w-full p-2 border border-gray-300 rounded"
              placeholder="e.g. 34.15"
              value="34.15"
              aria-describedby="councilY2Help"
            />
            <p id="councilY2Help" class="mt-1 text-sm text-gray-500">
              Town Council’s tax rate (mills) for FY 2027.
            </p>
          </div>
          <div>
            <label for="councilY3" class="block font-medium mb-1">
              Council Mill (FY 2028)
            </label>
            <input
              type="number"
              id="councilY3"
              step="0.01"
              class="w-full p-2 border border-gray-300 rounded"
              placeholder="e.g. 32.11"
              value="32.11"
              aria-describedby="councilY3Help"
            />
            <p id="councilY3Help" class="mt-1 text-sm text-gray-500">
              Town Council’s tax rate (mills) for FY 2028.
            </p>
          </div>
          <div>
            <label for="councilY4" class="block font-medium mb-1">
              Council Mill (FY 2029)
            </label>
            <input
              type="number"
              id="councilY4"
              step="0.01"
              class="w-full p-2 border border-gray-300 rounded"
              placeholder="e.g. 30.45"
              value="30.45"
              aria-describedby="councilY4Help"
            />
            <p id="councilY4Help" class="mt-1 text-sm text-gray-500">
              Town Council’s tax rate (mills) for FY 2029.
            </p>
          </div>
        </div>
      </div>

      <hr />

      <!-- Equalized Mill Rates (FY 2025–FY 2029) -->
      <div>
        <h3 class="text-lg font-semibold mb-2">Equalized Mill Rates</h3>
        <p class="mb-4 text-sm text-gray-500">
          These are the revenue-neutral rates for each phase-in level as if all properties 
          were already assessed at that percentage of market value (CT law uses 70%).  
          They serve only as the “baseline” for FY 2025→FY 2027.  
          *They are not used directly for FY 2028/FY 2029,* since you must add the 
          Council’s budget increase to them.
        </p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="equalizedY0" class="block font-medium mb-1">
              Equalized Rate (FY 2025)
            </label>
            <input
              type="number"
              id="equalizedY0"
              step="0.01"
              class="w-full p-2 border border-gray-300 rounded"
              placeholder="e.g. 27.97"
              value="27.97"
              aria-describedby="equalizedY0Help"
            />
            <p id="equalizedY0Help" class="mt-1 text-sm text-gray-500">
              Revenue-neutral (equalized) rate for FY 2025.
            </p>
          </div>
          <div>
            <label for="equalizedY1" class="block font-medium mb-1">
              Equalized Rate (FY 2026)
            </label>
            <input
              type="number"
              id="equalizedY1"
              step="0.01"
              class="w-full p-2 border border-gray-300 rounded"
              placeholder="e.g. 34.27"
              value="34.27"
              aria-describedby="equalizedY1Help"
            />
            <p id="equalizedY1Help" class="mt-1 text-sm text-gray-500">
              Revenue-neutral (equalized) rate for FY 2026.
            </p>
          </div>
          <div>
            <label for="equalizedY2" class="block font-medium mb-1">
              Equalized Rate (FY 2027)
            </label>
            <input
              type="number"
              id="equalizedY2"
              step="0.01"
              class="w-full p-2 border border-gray-300 rounded"
              placeholder="e.g. 31.88"
              value="31.88"
              aria-describedby="equalizedY2Help"
            />
            <p id="equalizedY2Help" class="mt-1 text-sm text-gray-500">
              Revenue-neutral (equalized) rate for FY 2027.
            </p>
          </div>
          <div>
            <label for="equalizedY3" class="block font-medium mb-1">
              Equalized Rate (FY 2028)
            </label>
            <input
              type="number"
              id="equalizedY3"
              step="0.01"
              class="w-full p-2 border border-gray-300 rounded"
              placeholder="e.g. 29.80"
              value="29.80"
              aria-describedby="equalizedY3Help"
            />
            <p id="equalizedY3Help" class="mt-1 text-sm text-gray-500">
              Revenue-neutral (equalized) rate for FY 2028.
            </p>
          </div>
          <div>
            <label for="equalizedY4" class="block font-medium mb-1">
              Equalized Rate (FY 2029)
            </label>
            <input
              type="number"
              id="equalizedY4"
              step="0.01"
              class="w-full p-2 border border-gray-300 rounded"
              placeholder="e.g. 27.97"
              value="27.97"
              aria-describedby="equalizedY4Help"
            />
            <p id="equalizedY4Help" class="mt-1 text-sm text-gray-500">
              Revenue-neutral (equalized) rate for FY 2029.
            </p>
          </div>
        </div>
      </div>

      <hr />

      <!-- Annual Budget Increase -->
      <div>
        <h3 class="text-lg font-semibold mb-2">Annual Budget Increase</h3>
        <div>
          <label for="futureBudgetIncrease" class="block font-medium mb-1">
            Projected Increase Rate
          </label>
          <input
            type="number"
            id="futureBudgetIncrease"
            step="0.001"
            class="w-full p-2 border border-gray-300 rounded"
            placeholder="e.g. 0.03"
            value="0.03"
            aria-describedby="futureBudgetIncreaseHelp"
          />
          <p id="futureBudgetIncreaseHelp" class="mt-1 text-sm text-gray-500">
            Enter as decimal (0.03 = 3 %) for how much the Council adds 
            to its mill rate in FY 2028 & FY 2029.
          </p>
        </div>
      </div>
    </div>

    <!--────────────────────────────────────
      Calculate Button
    ────────────────────────────────────-->
    <button
      id="calculateBtn"
      class="w-full bg-blue-600 text-white font-semibold py-3 rounded hover:bg-blue-700 transition mb-8"
      disabled
    >
      Calculate My Taxes
    </button>

    <!--────────────────────────────────────
      Results Section
    ────────────────────────────────────-->
    <div id="results" class="bg-white shadow-md rounded-lg p-6 space-y-4"></div>

    <!-- Version number visible to the user -->
    <div id="version">Version 1.2</div>
  </div>

  <script>
    // Cache DOM references
    const assessedPostInput         = document.getElementById('assessedPost');
    const assessedPreInput          = document.getElementById('assessedPre');
    const revalPctInput             = document.getElementById('revalPct');
    const councilY0Input            = document.getElementById('councilY0');
    const councilY1Input            = document.getElementById('councilY1');
    const councilY2Input            = document.getElementById('councilY2');
    const councilY3Input            = document.getElementById('councilY3');
    const councilY4Input            = document.getElementById('councilY4');
    const equalizedY0Input          = document.getElementById('equalizedY0');
    const equalizedY1Input          = document.getElementById('equalizedY1');
    const equalizedY2Input          = document.getElementById('equalizedY2');
    const equalizedY3Input          = document.getElementById('equalizedY3');
    const equalizedY4Input          = document.getElementById('equalizedY4');
    const futureBudgetIncreaseInput = document.getElementById('futureBudgetIncrease');
    const toggleAdvancedBtn         = document.getElementById('toggleAdvanced');
    const advancedConfigDiv         = document.getElementById('advancedConfig');
    const calculateBtn              = document.getElementById('calculateBtn');
    const resultsEl                 = document.getElementById('results');

    // Default rates for FY 2025–FY 2029
    const defaultRates = {
      councilY0:      37.49,
      councilY1:      35.64,
      councilY2:      34.15,
      councilY3:      32.11,
      councilY4:      30.45,
      equalizedY0:    27.97,
      equalizedY1:    34.27,
      equalizedY2:    31.88,
      equalizedY3:    29.80,
      equalizedY4:    27.97,
      futureIncrease: 0.03
    };

    // Enable/disable “Calculate” button based on valid Full Post-Reval input
    function validateInput() {
      const v = parseFloat(assessedPostInput.value);
      calculateBtn.disabled = isNaN(v) || v <= 0;
    }
    assessedPostInput.addEventListener('input', validateInput);
    validateInput(); // initial check on page load

    // Toggle advanced configuration visibility (with ARIA updates)
    toggleAdvancedBtn.addEventListener('click', () => {
      const isHidden = advancedConfigDiv.classList.contains('hidden');
      if (isHidden) {
        advancedConfigDiv.classList.remove('hidden');
        toggleAdvancedBtn.textContent = 'Hide Advanced Configuration ▲';
        toggleAdvancedBtn.setAttribute('aria-expanded', 'true');
      } else {
        advancedConfigDiv.classList.add('hidden');
        toggleAdvancedBtn.textContent = 'Advanced Configuration ▼';
        toggleAdvancedBtn.setAttribute('aria-expanded', 'false');
      }
    });

    // Helper: format currency with commas and two decimals
    function formatCurrency(num) {
      return Number(num.toFixed(2)).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // Helper: render a warning when phase-in data is missing
    function renderWarning() {
      resultsEl.innerHTML = `
        <div class="text-red-600 font-semibold">
          ⚠️ To see an accurate four-year phase-in, please enter 
          <strong>either</strong> your Old (pre-reval) assessment 
          <em>or</em> your Revaluation Increase (%) above.
        </div>
      `;
    }

    // Helper: render the full phase-in results with comparisons
    function renderWithDiff(taxY0, taxY1, taxY2, taxY3, taxY4) {
      const diffY1 = taxY1 - taxY0;
      const pctY1  = (diffY1 / taxY0) * 100;
      const diffY2 = taxY2 - taxY1;
      const pctY2  = (diffY2 / taxY1) * 100;
      const diffY3 = taxY3 - taxY2;
      const pctY3  = (diffY3 / taxY2) * 100;
      const diffY4 = taxY4 - taxY3;
      const pctY4  = (diffY4 / taxY3) * 100;

      resultsEl.innerHTML = `
        <div class="text-lg font-semibold mb-2">Estimated Annual Taxes</div>
        <div class="grid grid-cols-1 gap-2">
          <div class="flex justify-between border-b py-1">
            <span class="font-medium text-gray-800">FY 2025</span>
            <span class="text-gray-700">$${formatCurrency(taxY0)}</span>
          </div>
          <div class="flex justify-between border-b py-1">
            <span class="font-medium text-gray-800">FY 2026</span>
            <span class="text-gray-700">$${formatCurrency(taxY1)}</span>
          </div>
          <div class="flex justify-between border-b py-1">
            <span class="font-medium text-gray-800">FY 2027</span>
            <span class="text-gray-700">$${formatCurrency(taxY2)}</span>
          </div>
          <div class="flex justify-between border-b py-1">
            <span class="font-medium text-gray-800">FY 2028</span>
            <span class="text-gray-700">$${formatCurrency(taxY3)}</span>
          </div>
          <div class="flex justify-between border-b py-1">
            <span class="font-medium text-gray-800">FY 2029</span>
            <span class="text-gray-700">$${formatCurrency(taxY4)}</span>
          </div>
        </div>

        <div class="mt-6 text-lg font-semibold mb-2">Year-Over-Year Changes</div>
        <div class="grid grid-cols-1 gap-2">
          <div class="flex justify-between border-b py-1">
            <span class="text-gray-800">FY 2026 vs FY 2025</span>
            <span class="text-gray-700">
              $${formatCurrency(diffY1)} (${pctY1.toFixed(1)}%)
            </span>
          </div>
          <div class="flex justify-between border-b py-1">
            <span class="text-gray-800">FY 2027 vs FY 2026</span>
            <span class="text-gray-700">
              $${formatCurrency(diffY2)} (${pctY2.toFixed(1)}%)
            </span>
          </div>
          <div class="flex justify-between border-b py-1">
            <span class="text-gray-800">FY 2028 vs FY 2027</span>
            <span class="text-gray-700">
              $${formatCurrency(diffY3)} (${pctY3.toFixed(1)}%)
            </span>
          </div>
          <div class="flex justify-between border-b py-1">
            <span class="text-gray-800">FY 2029 vs FY 2028</span>
            <span class="text-gray-700">
              $${formatCurrency(diffY4)} (${pctY4.toFixed(1)}%)
            </span>
          </div>
        </div>
      `;
    }

    // Main calculation logic
    calculateBtn.addEventListener('click', () => {
      // 1) Read the Full 100% post-reval value (must be >0 to proceed)
      const postVal    = parseFloat(assessedPostInput.value) || 0;
      if (isNaN(postVal) || postVal <= 0) {
        renderWarning();
        return;
      }

      // 2) Pull in any Advanced overrides, but default to defaultRates
      let {
        councilY0, councilY1, councilY2, councilY3, councilY4,
        equalizedY0, equalizedY1, equalizedY2, equalizedY3, equalizedY4,
        futureIncrease
      } = defaultRates;

      if (!advancedConfigDiv.classList.contains('hidden')) {
        councilY0      = parseFloat(councilY0Input.value) || councilY0;
        councilY1      = parseFloat(councilY1Input.value) || councilY1;
        councilY2      = parseFloat(councilY2Input.value) || councilY2;
        councilY3      = parseFloat(councilY3Input.value) || councilY3;
        councilY4      = parseFloat(councilY4Input.value) || councilY4;
        equalizedY0    = parseFloat(equalizedY0Input.value) || equalizedY0;
        equalizedY1    = parseFloat(equalizedY1Input.value) || equalizedY1;
        equalizedY2    = parseFloat(equalizedY2Input.value) || equalizedY2;
        equalizedY3    = parseFloat(equalizedY3Input.value) || equalizedY3;
        equalizedY4    = parseFloat(equalizedY4Input.value) || equalizedY4;
        futureIncrease = parseFloat(futureBudgetIncreaseInput.value) || futureIncrease;
      }

      // 3) Figure out “oldVal” from either the “Old (Pre-Reval)” box or “Reval Pct”
      let oldVal = NaN;
      const preVal   = parseFloat(assessedPreInput.value) || NaN;
      const revalPct = parseFloat(revalPctInput.value) || NaN;

      if (!isNaN(preVal) && preVal > 0) {
        oldVal = preVal;
      } else if (!isNaN(revalPct) && revalPct > 0) {
        // If the user typed a plain “Revaluation %,” back out oldVal:
        oldVal = postVal / (1 + revalPct);
      }

      // If oldVal is missing, we cannot phase-in. Show warning.
      if (isNaN(oldVal) || oldVal <= 0) {
        renderWarning();
        return;
      }

      // 4) Compute the 5 phased-in assessed values (FY 2025→FY 2029):
      //    • FY 2025 (0%) = oldVal
      //    • FY 2026 (25%) = oldVal + 0.25×(postVal − oldVal)
      //    • FY 2027 (50%) = oldVal + 0.50×(postVal − oldVal)
      //    • FY 2028 (75%) = oldVal + 0.75×(postVal − oldVal)
      //    • FY 2029 (100%) = postVal
      const diff     = postVal - oldVal;
      const assessY0 = oldVal;                  // FY 2025
      const assessY1 = oldVal + 0.25 * diff;     // FY 2026
      const assessY2 = oldVal + 0.50 * diff;     // FY 2027
      const assessY3 = oldVal + 0.75 * diff;     // FY 2028
      const assessY4 = postVal;                 // FY 2029

      // 5) Convert each to “mills” (÷ 1000)
      const millY0 = assessY0 / 1000;
      const millY1 = assessY1 / 1000;
      const millY2 = assessY2 / 1000;
      const millY3 = assessY3 / 1000;
      const millY4 = assessY4 / 1000;

      // 6) Tax calculation function for each year
      function taxForYear(millUnits, yearIdx) {
        if (yearIdx === 0) {
          // FY 2025 uses the equalized baseline
          return millUnits * equalizedY0;
        }
        if (yearIdx === 1) {
          // FY 2026 uses its equalized baseline
          return millUnits * equalizedY1;
        }
        if (yearIdx === 2) {
          // FY 2027 uses its equalized baseline
          return millUnits * equalizedY2;
        }
        if (yearIdx === 3) {
          // FY 2028 uses Council Y3 plus the budget increase
          return (millUnits * councilY3) * (1 + futureIncrease);
        }
        // yearIdx === 4 → FY 2029
        return (millUnits * councilY4) * (1 + futureIncrease);
      }

      // 7) Compute taxes for FY 2025–FY 2029
      const taxY0 = taxForYear(millY0,  0);
      const taxY1 = taxForYear(millY1,  1);
      const taxY2 = taxForYear(millY2,  2);
      const taxY3 = taxForYear(millY3,  3);
      const taxY4 = taxForYear(millY4,  4);

      // 8) Render the five-year table + year-over-year comparisons
      renderWithDiff(taxY0, taxY1, taxY2, taxY3, taxY4);
    });
  </script>
</body>
</html>
